function checkKey(e){if(e=e||window.event,!$("input").is(":focus"))switch(e.keyCode){case 37:rewind();break;case 39:skip();break;case 32:playPause()}}function rewind(e=seekTime){let t=seekTime;e!==seekTime&&(t=seekTime,window.seekTime=e),videoPlayer.currentTime-=e,t!==seekTime&&(window.seekTime=t)}function skip(e=seekTime){let t=seekTime;e!==seekTime&&(t=seekTime,window.seekTime=e),videoPlayer.currentTime+=e,t!==seekTime&&(window.seekTime=t)}function playPause(){isPlaying()?videoPlayer.pause():videoPlayer.play()}function isPlaying(){return!videoPlayer.paused}function playFrom(e){videoPlayer.currentTime=e,videoPlayer.play()}function addLocation(e){ajax("ajax/add_videolocation.php","videoID="+videoID+"&locationID="+e)}function removeLocation(e){ajax("ajax/remove_videolocation.php","videoID="+videoID+"&locationID="+e)}function addAttribute(e){ajax("ajax/add_videoattribute.php","videoID="+videoID+"&attributeID="+e)}function removeAttribute(e){ajax("ajax/remove_videoattribute.php","videoID="+videoID+"&attributeID="+e)}function renameVideo(e){ajax("ajax/rename_video.php",`videoID=${videoID}&videoName=${encodeURIComponent(e)}`)}function renameFile(e){ajax("ajax/rename_file.php",`videoID=${videoID}&videoPath=${encodeURIComponent(e)}`)}function addBookmark(e,t){let o=Math.round(videoPlayer.currentTime);localStorage.bookmark=o,ajax("ajax/add_bookmark.php",`seconds=${o}&categoryID=${e}&videoID=${videoID}`,function(i){if(!$("#timeline").length){let e=document.createElement("div");e.setAttribute("id","timeline"),insertBefore(document.getElementById("videoDetails"),e)}let a=document.getElementById("timeline");if(!$('.bookmark[data-bookmark-time="'+o+'"][data-category-id="'+e+'"]').length){let n=document.createElement("a");n.classList.add("bookmark","btn"),n.setAttribute("data-category-id",e),n.setAttribute("data-bookmark-id",i.responseText),n.setAttribute("data-bookmark-time",o.toString()),n.setAttribute("data-level","1"),n.setAttribute("href","javascript:;"),n.setAttribute("style",`margin-left: ${getOffset(o)}%`),n.textContent=t,a.appendChild(n)}animation("checkbox.png"),$(bookmark).on("click",function(){playFrom($(this).attr("data-bookmark-time"))}),bookmarkCollision()})}function bookmark_editCategory(e,t){ajax("ajax/bookmark_editCategory.php","bookmarkID="+e+"&categoryID="+t)}function bookmark_editTime(e){let t=Math.round(videoPlayer.currentTime);localStorage.bookmark=t,ajax("ajax/bookmark_editTime.php","bookmarkID="+e+"&seconds="+t,function(){let o=document.querySelector('.bookmark[data-bookmark-id="'+e+'"]');o.setAttribute("style","margin-left: "+getOffset(t)+"%"),o.setAttribute("data-bookmark-time",t.toString()),animation("checkbox.png"),bookmarkCollision()})}function removeBookmark(e){ajax("ajax/remove_bookmark.php","id="+e)}function removeBookmarks(){ajax("ajax/remove_bookmarks.php","videoID="+videoID)}function removeVideoCategory(e,t){ajax("ajax/remove_videocategory.php","videoID="+e+"&categoryID="+t)}function removeVideoStar(e,t){ajax("ajax/remove_videostar.php","videoID="+e+"&starID="+t)}function addCategory_and_bookmark(e,t){$("#dialog").dialog("close");let o=Math.round(videoPlayer.currentTime);localStorage.bookmark=o,ajax("ajax/add_category_and_bookmark.php",`videoID=${videoID}&categoryID=${e}&seconds=${o}`,function(i){if(!$("#timeline").length){let e=document.createElement("div");e.setAttribute("id","timeline"),insertBefore(document.getElementById("videoDetails"),e)}let a=document.getElementById("timeline");if(!$("#categories").length){let e=document.createElement("div");e.setAttribute("id","categories"),insertBefore(document.querySelector("#videoDetails > div[style]"),e)}let n=document.getElementById("categories");if(!$('.category[data-category-id="'+e+'"]').length){let o=document.createElement("a");o.classList.add("category","btn"),o.setAttribute("data-category-id",e),o.setAttribute("href","category.php?id="+e),o.textContent=t,n.appendChild(o)}if(!$('.bookmark[data-bookmark-time="'+o+'"][data-category-id="'+e+'"]').length){let n=document.createElement("a");n.classList.add("bookmark","btn"),n.setAttribute("data-category-id",e),n.setAttribute("data-bookmark-id",i.responseText),n.setAttribute("data-bookmark-time",o.toString()),n.setAttribute("data-level","1"),n.setAttribute("href","javascript:;"),n.setAttribute("style","margin-left: "+getOffset(o)+"%"),n.textContent=t,a.appendChild(n)}animation("checkbox.png"),$(bookmark).on("click",function(){playFrom($(this).attr("data-bookmark-time"))}),bookmarkCollision()})}function generateThumbnail(){ajax("ajax/video_generatethumbnail.php","videoID="+videoID)}function removeVideo(){ajax("ajax/remove_video.php","videoID="+videoID)}function setAge(e){ajax("ajax/video_age.php","videoID="+videoID+"&age="+e)}function ajax(e,t,o=function(){location.href=location.href}){let i=e+"?"+t,a=new XMLHttpRequest;a.open("GET",i),a.send(),a.onreadystatechange=function(){4===this.readyState&&200===this.status&&o(this)}}function categorySearch(){let e="";document.addEventListener("keydown",function(t){function o(e){document.querySelector(".search > .inner")&&(document.querySelector(".search > .inner").textContent=e)}(8===t.which&&e.length||32===t.which||t.which>=65&&t.which<=90)&&(t.preventDefault(),8===t.which?o(e=e.slice(0,-1)):o(e+=String.fromCharCode(t.which).toLowerCase()),$("#dialog .btn").removeClass("no-match").not(function(){return this.textContent.toLowerCase().indexOf(e)>-1}).addClass("no-match"))})}function hasNoStar(){return!$(".star").length}function hasNoBookmarks(){return!$(".bookmark").length}function collisionCheck(e,t){const o=5,i=35;let a=e.getBoundingClientRect(),n=$(e).offset().left,d=$(e).offset().top,r=t.getBoundingClientRect(),c=$(t).offset().left,l=$(t).offset().top,s=Math.abs(n+a.width-c),m=Math.abs(d-l);return!(a.right<r.left||a.left>r.right||a.bottom<r.top||a.top>r.bottom)||s<o&&m<i}function _collisionCheck(e,t){let o=e.getBoundingClientRect(),i=t.getBoundingClientRect(),a=$(e).offset().left,n=$(t).offset().left,d=$(e).offset().top,r=$(t).offset().top,c=Math.abs(a+o.width-n),l=Math.abs(d-r);return!(o.right<i.left||o.left>i.right||o.bottom<i.top||o.top>i.bottom)||c<10&&l<35}function bookmarkCollision(){$(bookmark).attr("data-level",1);for(let e=0;e<bookmark.length;e++){let t=$(bookmark).eq(e).attr("data-level");if(e){let o=bookmark[e-1],i=bookmark[e];!function a(){setTimeout(function(){collisionCheck(o,i)&&(t=t<10?++t:1,$(bookmark).eq(e).attr("data-level",t),a())},250)}()}}}function onFocus(e){document.hasFocus()?(e(),onBlur(e)):setTimeout(function(){onFocus(e)})}function onBlur(e){document.hasFocus()?setTimeout(function(){onBlur(e)}):onFocus(e)}function autoComplete(){let e=[];const t=$(".star-autocomplete");for(let o=0;o<t.length;o++)e.push(t.eq(o).text());$('input[name="star"]').autocomplete({source:[e]})}function videoVolume(e=1){if(e>1){let t=new AudioContext,o=t.createMediaElementSource(videoPlayer),i=t.createGain();i.gain.value=e,o.connect(i),i.connect(t.destination)}else e>=0&&(videoPlayer.volume=e)}function getOffset(e){let t=100*(e/duration);return t+=.5}function animation(e,t=300,o=t){let i=document.createElement("img");i.src="css/images/"+e,i.classList.add("symbol"),insertBefore(document.getElementsByClassName("plyr")[0],i),$(i).fadeIn(t,function(){$(this).fadeOut(o,function(){i.remove()})})}function insertBefore(e,t){e.insertBefore(t,e.firstChild)}function windowResize(e){let t;window.addEventListener("resize",function(){clearInterval(t),t=setTimeout(function(){e()},100)})}document.addEventListener("DOMContentLoaded",function(){if(window.videoWrapper=document.getElementById("video"),window.videoPlayer=document.getElementsByTagName("video")[0],window.videoSource=document.querySelector('source[type="application/x-mpegURL"]'),window.videoID=window.location.href.split("id=")[1],window.videoHeight=500,window.seekTime=1,window.bookmark=document.getElementsByClassName("bookmark"),window.duration=document.getElementById("duration").textContent,window.videoTitle=document.getElementById("video-name"),document.addEventListener("keydown",function(e){switch(e.keyCode){case 9:e.preventDefault(),$("#next")[0].click()}}),void 0!==localStorage.bookmark&&(window.seconds=parseInt(localStorage.bookmark),localStorage.video===videoID?(videoPlayer.currentTime=seconds,void 0!==localStorage.playing&&parseInt(localStorage.playing)&&setTimeout(function(){videoPlayer.play()},100)):(localStorage.video=videoID,localStorage.bookmark=0)),videoSource&&Hls.isSupported()){const e=new Hls({maxBufferLength:180});e.loadSource(videoSource.getAttribute("src")),e.attachMedia(videoPlayer)}new Plyr(videoPlayer,{controls:["play-large","play","progress","current-time","fullscreen"],invertTime:!1,toggleInvert:!1,seekTime:window.seekTime,volume:1,muted:!1,previewThumbnails:{enabled:!1,src:"vtt/"+videoID+".vtt"},hideControls:!1}),videoWrapper.addEventListener("wheel",function(e){e.deltaY<0?skip(10):rewind(10)}),videoWrapper.addEventListener("timeupdate",function(){localStorage.bookmark=Math.round(videoPlayer.currentTime),localStorage.video!==videoID&&(localStorage.video=videoID)}),videoWrapper.addEventListener("playing",function(){localStorage.playing=1}),videoWrapper.addEventListener("pause",function(){localStorage.playing=0}),videoWrapper.addEventListener("enterfullscreen",function(){videoPlayer.style.maxHeight="none"}),videoWrapper.addEventListener("exitfullscreen",function(){videoPlayer.style.maxHeight=videoHeight+"px"}),$(bookmark).on("click",function(){playFrom($(this).attr("data-bookmark-time"))}),autoComplete(),videoVolume(.125),onFocus(bookmarkCollision),windowResize(function(){bookmarkCollision()})}),document.onkeydown=checkKey,$(function(){$.contextMenu({selector:"#video > h2 #video-name",items:{rename_title:{name:"Rename",icon:"edit",callback:function(){$("body").append('<div id="dialog" title="Edit Video"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:250}),e.append('<input type="text" name="videoName_edit" value="'+videoTitle.textContent+'" autofocus>');let t=$('input[name="videoName_edit"]'),o=t.val().length;t[0].focus(),t[0].setSelectionRange(o,o),document.querySelector('input[name="videoName_edit"]').addEventListener("keydown",function(e){13===e.keyCode&&renameVideo(this.value)})})}},add_attribute:{name:"Add Attribute",icon:"fas fa-tag",callback:function(){$("body").append('<div id="dialog" title="Add Attribute"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:250,position:{my:"top",at:"top+150"}}),e.append('<span class="search"><span class="inner"></span></span>');const t=$("#attributes.hidden > .attribute");for(let o=0;o<t.length;o++){let i=t.eq(o).attr("data-attribute-id"),a=t.eq(o).text();e.append('<div class="btn unselectable" onclick="addAttribute('+i+')">'+a+"</div>")}categorySearch()})}},add_location:{name:"Add Location",icon:"fas fa-map-marker-alt",callback:function(){$("body").append('<div id="dialog" title="Add Location"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:250,position:{my:"top",at:"top+150"}}),e.append('<span class="search"><span class="inner"></span></span>');const t=$("#locations.hidden > .location");for(let o=0;o<t.length;o++){let i=t.eq(o).attr("data-location-id"),a=t.eq(o).text();e.append('<div class="btn unselectable" onclick="addLocation('+i+')">'+a+"</div>")}categorySearch()})}}}})}),$(function(){$.contextMenu({selector:".bookmark",items:{edit:{name:"Change Category",icon:"edit",callback:function(e,t){let o=t.$trigger.attr("data-bookmark-id"),i=t.$trigger.text().trim();$("body").append('<div id="dialog" title="Change Category"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:250,position:{my:"top",at:"top+150"}}),e.append('<span class="search"><span class="inner"></span></span>');const t=$("#category_list > option");for(let a=0;a<t.length;a++){let n=t.eq(a),d=n.attr("data-category-id"),r=n.attr("value");r!==i&&e.append('<div class="btn unselectable" onclick="bookmark_editCategory('+o+","+d+')">'+r+"</div>")}categorySearch()})}},edit_time:{name:"Change Time",icon:"far fa-clock",callback:function(e,t){bookmark_editTime(t.$trigger.attr("data-bookmark-id"))}},divider:"---",delete:{name:"Delete",icon:"delete",callback:function(e,t){removeBookmark(t.$trigger.attr("data-bookmark-id"))}}}})}),$(function(){$.contextMenu({selector:".category",items:{add_bookmark:{name:"Add Bookmark",icon:"add",callback:function(e,t){addBookmark(t.$trigger.attr("data-category-id"),t.$trigger.text())}},divider:"---",remove:{name:"Remove",icon:"delete",callback:function(e,t){let o=t.$trigger.attr("data-category-id");removeVideoCategory(videoID,o)}}}})}),$(function(){$.contextMenu({selector:".star[data-star-id]",items:{add_bookmark:{name:"Add Bookmark",icon:"add",callback:function(){$("body").append('<div id="dialog" title="Add Bookmark"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:250,position:{my:"right top",at:"right-160 top+250"}}),e.append('<span class="search"><span class="inner"></span></span>');const t=$("#category_list > option");for(let o=0;o<t.length;o++){let i=t.eq(o).attr("data-category-id"),a=t.eq(o).attr("value");e.append('<div class="btn unselectable" onclick="addCategory_and_bookmark('+i+",'"+a+"')\">"+a+"</div>")}categorySearch()})}},divider:"---",remove:{name:"Remove",icon:"delete",callback:function(e,t){let o=t.$trigger.attr("data-star-id");removeVideoStar(videoID,o)}}}})}),$(function(){$.contextMenu({selector:"#video .plyr",zIndex:3,items:{set_age:{name:"Set Age",icon:"add",callback:function(){$("body").append('<div id="dialog" title="Set Age"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:350}),e.append('<input type="number" name="videoAge_set" autofocus>'),document.querySelector('input[name="videoAge_set"]').addEventListener("keydown",function(e){13===e.keyCode&&setAge(this.value)})})}},rename_video:{name:"Rename File",icon:"edit",callback:function(){let e=$(videoPlayer).find("source").not('[type="video/webm"]').first().attr("src"),t=e.split("/")[1]+"/"+e.split("/")[2];$("body").append('<div id="dialog" title="Edit File"></div>'),$(function(){const e=$("#dialog");e.dialog({close:function(){$(this).dialog("close"),this.closest(".ui-dialog").remove()},width:350}),e.append('<input type="text" name="videoFile_edit" value="'+t+'" autofocus>');let o=$('input[name="videoFile_edit"]'),i=o.val().length;o[0].focus(),o[0].setSelectionRange(i,i),document.querySelector('input[name="videoFile_edit"]').addEventListener("keydown",function(e){13===e.keyCode&&renameFile(this.value)})})}},fix_thumbnail:{name:"Fix Thumbnail",icon:"edit",callback:function(){generateThumbnail()}},divider:"---",remove_bookmarks:{name:"Remove Bookmarks",icon:"delete",callback:function(){removeBookmarks()},disabled:hasNoBookmarks()},remove_video:{name:"Remove Video",icon:"delete",callback:function(){removeVideo()},disabled:!(hasNoStar()&&hasNoBookmarks())}}})}),$(function(){$.contextMenu({selector:"#video > h2 small > span.attribute",items:{remove_attribute:{name:"Remove Attribute",icon:"delete",callback:function(e,t){removeAttribute(t.$trigger.attr("data-attribute-id"))}}}})}),$(function(){$.contextMenu({selector:"#video > h2 small > span.location",items:{remove_location:{name:"Remove Location",icon:"delete",callback:function(e,t){removeLocation(t.$trigger.attr("data-location-id"))}}}})});